
stages:
- stage: BuildUnitTests
  displayName: 'Build and run unit tests'
  dependsOn: []
  jobs:
  - job: Windows
    pool:
      vmImage: $(WindowsVmImage)
    steps:
    - template: build.yml

  - job: Linux
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - template: build.yml
      parameters:
        packageArtifacts: false

- stage: DockerBuild  
  displayName: 'Build images'
  dependsOn: []
  jobs:
  - template: docker-build-all.yml
    parameters: 
      tag: $(ImageTag)

- stage: provisionEnvironment
  displayName: Provision Environment
  dependsOn: []
  jobs:
  - job: provision
    steps:
    - task: AzurePowerShell@4
      displayName: Provision Resource Group
      inputs:
        azureSubscription: $(ConnectedServiceName)
        azurePowerShellVersion: latestVersion
        ScriptType: inlineScript
        Inline: |
          New-AzResourceGroup -Name "$(DeploymentEnvironmentName)" -Location "$(ResourceGroupRegion)" -Force

- stage: aadTestEnvironment
  displayName: Setup AAD Test Environment
  dependsOn:
  - provisionEnvironment
  - DockerBuild
  jobs:
  - template: ./jobs/add-aad-test-environment.yml

- stage: deployStu3
  displayName: 'Deploy STU3 Site'
  dependsOn:
  - provisionEnvironment
  - DockerBuild
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: Stu3
      webAppName: $(DeploymentEnvironmentName)
      appServicePlanName: $(appServicePlanName)
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(DeploymentEnvironmentName)
      testEnvironmentUrl: $(TestEnvironmentUrl)
      imageTag: $(ImageTag)

- stage: deployStu3Sql
  displayName: 'Deploy STU3 SQL Site'
  dependsOn:
  - provisionEnvironment
  - DockerBuild
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: Stu3
      sql: true
      webAppName: $(DeploymentEnvironmentNameSql)
      appServicePlanName: $(appServicePlanName)
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(DeploymentEnvironmentName)
      testEnvironmentUrl: $(TestEnvironmentUrl)
      imageTag: $(ImageTag)
  
- stage: testStu3
  displayName: 'Run Stu3 Tests'
  dependsOn:
  - BuildUnitTests
  - aadTestEnvironment
  - deployStu3
  - deployStu3Sql
  jobs:
  - template: ./jobs/run-tests.yml
    parameters:
      version: Stu3
      keyVaultName: $(DeploymentEnvironmentName)

# DESCRIPTION: 	
# Builds, tests, and packages the solution for all PR requests.	

name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:-r)
trigger: none

variables:
- template: ci-variables.yml
- template: build-variables.yml

stages:
- stage: provisionEnvironment
  displayName: Provision Environment
  dependsOn: []
  jobs:
  - job: provision
    steps:
    - task: AzurePowerShell@4
      displayName: Provision Resource Group
      inputs:
        azureSubscription: $(ConnectedServiceName)
        azurePowerShellVersion: latestVersion
        ScriptType: inlineScript
        Inline: |
          New-AzResourceGroup -Name "$(DeploymentEnvironmentName)" -Location "$(ResourceGroupRegion)" -Force

- stage: deployStu3Sql
  displayName: 'Deploy STU3 SQL Site'
  dependsOn: 
  - provisionEnvironment
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: Stu3
      sql: true
      webAppName: $(DeploymentEnvironmentName)
      appServicePlanName: $(appServicePlanName)
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(DeploymentEnvironmentName)
      testEnvironmentUrl: $(TestEnvironmentUrl)
      imageTag: $(ImageTag)

- stage: securityScan
  displayName: Security Scan
  dependsOn: []
  jobs:
  - job: runScan
    pool:
      vmImage: $(WindowsVmImage)
    steps:
    - task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@3
      displayName: 'Run MpCmdRun.exe'
      inputs:
        FileDirPath: '$(System.ArtifactsDirectory)'
        EnableServices: true
        SignatureFreshness: OneDay
        TreatStaleSignatureAs: Warning

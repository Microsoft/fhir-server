# DESCRIPTION: 
# Builds and pushes a docker image for a given FHIR version

parameters:
- name: version
  type: string
- name: tag
  type: string

variables:
  azureSubscriptionEndpoint: 'docker-build'
  azureContainerRegistry: 'healthplatformregistry.azurecr.io'
 
steps:
- task: DockerCompose@0
  displayName: 'Build FHIR ${{parameters.version}} Server Image'
  inputs:
    action: Build services
    azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
    azureContainerRegistry: $(azureContainerRegistry)
    dockerComposeFile: build/docker/docker-compose.yaml
    dockerComposeFileArgs: FHIR_VERSION = ${{parameters.version}}
    projectName: ${{parameters.version}}
    additionalImageTags: ${{parameters.tag}}

- task: DockerCompose@0
  displayName: 'Push FHIR ${{parameters.version}} Server Image'
  inputs:
    action: Push services
    azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
    azureContainerRegistry: $(azureContainerRegistry)
    dockerComposeFile: build/docker/docker-compose.yaml
    projectName: ${{parameters.version}}
    additionalImageTags: ${{parameters.tag}}

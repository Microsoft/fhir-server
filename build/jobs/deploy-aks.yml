
parameters:
- name: version
  type: string
- name: sql
  type: boolean
  default: false
- name: deploymentEnvironmentName
  type: string
- name: subscription
  type: string
- name: clusterName
  type: string
- name: clusterResourceGroup
  type: string
- name: clusterLocation
  type: string
- name: testEnvironmentUrl
  type: string
- name: imageTag
  type: string

jobs:
- job: provisionEnvironment
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: resolute-oss-tenant-info'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: 'resolute-oss-tenant-info'

  - task: AzureCLI@2
    displayName: 'Azure CLI: InlineScript'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az aks get-credentials --name ${{parameters.clusterName}} --resource-group ${{parameters.clusterResourceGroup}}

        helmChartPath="$(System.DefaultWorkingDirectory)/samples/kubernetes/helm/fhir-server/"
        repositoryName="$(azureContainerRegistry)/${{parameters.version}}_fhir-server"
        releaseName="${{parameters.deploymentEnvironmentName}}-${{parameters.version}}"
        
        helm upgrade --install $releaseName $helmChartPath \
          --set image.repository=$repositoryName \
          --set image.tag=${{parameters.imageTag}} \
          --set database.resourceGroup="${{parameters.clusterResourceGroup}}" \
          --set database.location=${{parameters.clusterLocation}} \
          --wait --timeout 10m

        helm list
        kubectl get svc "$releaseName-fhir-server"

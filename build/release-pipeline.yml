# DESCRIPTION: 	
# Builds, tests, and packages the solution for all PR requests.	

name: build/$(Date:yyyyMMdd)$(Rev:-r)

variables:
- template: build-variables.yml
- template: ci-variables.yml

stages:
- template: build-deploy.yml

- stage: securityScan
  displayName: Security Scan
  dependsOn: []
  jobs:
  - job: runScan
    pool:
      vmImage: $(WindowsVmImage)
    steps:
    - task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@3
      displayName: 'Run MpCmdRun.exe'
      inputs:
        FileDirPath: '$(System.ArtifactsDirectory)'
        EnableServices: true
        SignatureFreshness: OneDay
        TreatStaleSignatureAs: Warning

- stage: publishReleaseImage
  displayName: Publish Release Image
  dependsOn:
  - testStu3
  - testR4
  - testR5
  jobs:
  - job: deleteCandidate
    pool: 
      vmImage: $(WindowsVmImage)
    steps:
    - task: AzureCLI@2
      displayName: Delete Candidate
      imputs:
        azureSubscription: $(ConnectedServiceName)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          az acr repository delete -n HealthPlatformRegistry --image stu3_fhir-server:$(ImageTag)
          az acr repository delete -n HealthPlatformRegistry --image r4_fhir-server:$(ImageTag)
          az acr repository delete -n HealthPlatformRegistry --image r5_fhir-server:$(ImageTag)

  - tempate: docker-build-all.yml
    parameters:
      tag: $(ReleaseTag)

- stage: publishMyGet
  displayName: Publish Assets MyGet
  dependsOn:
  - testStu3
  - testR4
  - testR5
  jobs:
  - job: publish
    pool:
      vmImage: $(WindowsVmImage)
    steps:
    - task: NuGetCommand@2
      displayName: 'Nuget Push MyGet'
      inputs:
        command: push
        packagesToPush: '$(System.ArtifactsDirectory)/**/*.nupkg'
        nuGetFeedType: external
        publishFeedCredentials: 'Microsoft FHIR Server MyGet'

- stage: githubRelease
  displayName: Create Github Release
  dependsOn:
  - publishMyGet
  jobs:
  - job: release
    pool:
      vmImage: $(WindowsVmImage)
    steps:
    - task: GitHubRelease@1
      displayName: 'GitHub release (create)'
      inputs:
        gitHubConnection: 'GitHub (mshsvc)'
        repositoryName: '$(build.Repository.Name)'
        tagSource: userSpecifiedTag
        tag: 'build/$(Date:yyyyMMdd)$(Rev:-r)'
        changeLogCompareToRelease: lastNonDraftRelease
